<!DOCTYPE html>
<html>
<head>
	<meta charset='utf-8'>
	<meta name='viewport' content='width=device-width, initial-scale=1.0'>
	<title>Données en cordée</title>

	<script type='text/javascript' src='https://d3js.org/d3.v4.min.js'></script>
	<script type='text/javascript' src='https://d3js.org/d3-selection-multi.v1.min.js'></script>
	<!-- <script type='text/javascript' src='https://unpkg.com/topojson@3'></script> -->
	<!-- <script type='text/javascript' src='https://npmcdn.com/@turf/turf/turf.min.js'></script> -->
	<!-- <script type='text/javascript' src='./libs/d3.min.js'></script>
	<script type='text/javascript' src='./libs/d3-selection-multi.min.js'></script>
	<script type='text/javascript' src='./libs/topojson.min.js'></script>
	<script type='text/javascript' src='./libs/turf.min.js'></script> -->

	<script type='text/javascript' src='./js/base.fn.js'></script>
	<script type='text/javascript' src='./js/modules.ui.js'></script>
	<script type='text/javascript' src='./js/modules.menu.js'></script>
	<script type='text/javascript' src='./js/modules.mountains.js'></script>
	<script type='text/javascript' src='./js/modules.map.js'></script>
	<script type='text/javascript' src='./js/modules.reasoning.js'></script>

	<link rel='stylesheet' type='text/css' href='./css/main.css'>
	<link rel='stylesheet' type='text/css' href='./css/shapes.css'>
</head>

<body>

	<div class='slide bg-dark center welcome'>
		<div class='slide'>
		<!-- <div class='inner center'> -->
			<div class='main-header'>
				<div class='sticky-content'>
					<div class='montagnes-logo main'>
						<div class='sommet--logo logo-sommet-1'></div>
						<div class='sommet--logo logo-sommet-2'></div>
						<div class='sommet--logo logo-sommet-3'></div>
					</div>
					<div class='logo-separator'>
						<a href='a_propos.html'><div class='node--logo about' data-content='À propos'></div></a>
						<a href='indicateurs.html'><div class='node--logo indicators' data-content='Les données'></div></a>
					</div>
				</div>
			</div>
			<div class='main-title'>Données—en—cordée</div>
			<div class='main-subtitle'>Un paysage social du département de l’Isère</div>
		</div>
			
		<div class='flex--col'>
			<!-- <p class='lead'>Véritable collectivité de proximité, <b>le Département de l’Isère </b>est un acteur clé de l’aménagement du territoire, de la protection et de l’accompagnement des populations à tous les âges de la vie. Chef de file de la solidarité, il est le garant d’une équité territoriale et sociale à l’échelle de l’Isère. Dans ce cadre, il s’est doté d’un observatoire sociodémographique qui produit annuellement des données fiabilisées, expertisées et consolidées. Réunies à l’intérieur d’un document unique d’observation, ces éléments permettent d’améliorer la connaissance du territoire et de ses habitants. Ce « Portrait Social de l’Isère en chiffres » est un véritable outil d’aide à la décision qui permet de caractériser les spécificités et dynamiques territoriales.Existant sous la forme « figée » d’un tableur, il est revisité sur ce site en un outil de data-visualisation qui doit permettre aux citoyens d’appréhender de manière ludique et facile les enjeux sociaux et démographiques des territoires isérois. En illustrant la diversité des réalités territoriales, cet outil doit permettre au citoyen de créer son propre diagnostic « éclairé » en allant parfois à l’encontre des images et idées reçues qui collent à certains territoires. Organisé autour de 4 grandes thématiques (population, économie et emploi, vie sociale, solidarités) cette publication observe une 400ène de zonages différents allant des communes aux EPCI en passant par les territoires départementaux. Existant sous la forme « figée » d’un tableur, il est revisité sur ce site en un outil de data visualisation qui doit permettre aux citoyens d’appréhender de manière ludique et facile les enjeux sociaux et démographiques des territoires isérois. En illustrant la diversité des réalités territoriales, cet outil doit permettre au citoyen de créer son propre diagnostic « éclairé » en allant parfois à l’encontre des images et idées reçues qui collent à certains territoires.</p> -->

			<!-- <p class='lead'>Données en cordée est un démonstrateur réalisé par Pauline Gourlet et Jeremy Boy dans le cadre du projet Open City. Il propose à chacun de peindre un paysage singulier des données publiques du département de l’Isère à l’aide d’un outil de visualisation graphique et ludique. Ce projet s’inscrit dans la stratégie d’ouverture des données du département.</p> -->
			<p class='lead'>Le projet Données en cordée s’inscrit dans une volonté d’ouverture et de partage des données publiques du département de l’Isère. Ce site propose un outil d’exploration des spécificités et des dynamiques territoriales. Sous la forme d’un paysage de montagne, il rend visibles et manipulables les données du « Portrait social de l’Isère en chiffres », développé par l’observatoire sociodémographique du département.</p>
			 <!-- — jeu de données téléchargeable ici.</p> -->

			<p class='lead intertitre'>Déclinaison de la métaphore du paysage de montagne.</p>
			<p class='lead'>Les données ouvertes fournies sont représentées par des monts, dont les hauteurs varient selon les valeurs et les formes selon les types de données. Pour mieux comprendre certaines tendances, des opérations de base sont également permises et permettent de combiner ces données. En jouant avec les différents indicateurs et opérateurs, chacun peut ainsi composer son paysage, tout en sachant en lire le sens.</p>

			<div class='legende'>
				<p class='small'><u>Trois types de données et deux opérations</u></p>
				<div class='ligne-1'>
					<div class='legende--flexbox'>
						<div class='s-group discrete'>
							<div class='sommet--legende discrete'></div>
							<div class='legende--label'>Données nominales</div>
						</div>
						<div class='s-group series'>
							<div class='sommet--legende series'></div>
							<div class='legende--label'>Données d’intervalle</div>
						</div>
						<div class='s-group ordinal'>
							<div class='sommet--legende ordinal'></div>
							<div class='legende--label'>Données ordinales</div>
						</div>
					</div>
				</div>
				<!-- <p><u>Deux opérations</u></p> -->
				<div class='ligne-2'>
					<div class='legende--flexbox'>
						<div class='s-group addition'>
							<div class='sommet--legende addition'></div>
							<svg viewbox='0 0 100 100' preserveAspectRatio='xMinYMid meet'><path d='M25,50 L75,50'></svg>
							<div class='legende--label'>Addition</div>
						</div>
						<div class='s-group division'>
							<div class='sommet--legende division'></div>
							<svg viewbox='0 0 100 100' preserveAspectRatio='xMinYMid meet'><path d='M0,100 L50,0 L100,100'></svg>
							<div class='legende--label'>Division</div>
						</div>
					</div>
				</div>
			</div>


			
			<div class='download large flex--col'>
				<a href="./data/src/donnees.zip" download>
					<button class='download'>Télécharger les données</button>
				</a>
			</div>


		</div>
	</div>

	<div class='slide vis bg-uniform'>
	<!-- <div class='slide vis bg-gradient'> -->
		<div class='header'>
			<div class='btn abs-scale active'>Absolue</div>
			<div class='btn norm-scale'>Par habitant</div>
		</div>

		<div class='content'>
			<div class='menu--vis'>
			</div>
			<div class='paysage--vis'>
			</div>
			<div class='cordee--vis'>
			</div>
		</div>
	</div>

<script type='text/javascript'>
	let maxHeight
	const debug = false

	var montagnes

	console.log(detectBrowser(), detectVersion())
	console.log('are clip-paths supported? ' + areClipPathShapesSupported())
	console.log(window.devicePixelRatio)
	console.log(window.screen.availWidth, window.screen.availHeight)

	// const promise = []
	// promise.push(d3.csv('./data/data.csv'))
	// promise.push(d3.csv('./data/indicators.csv'))
	// promise.push(d3.json('./data/carte-redessinee.json'))
	// Promise.all(promise).then(function (res) {

	d3.queue()
	.defer(d3.csv, './data/data.csv')
	.defer(d3.csv, './data/indicators.csv')
	.defer(d3.json, './data/carte-redessinee.json')
	.awaitAll(function(err, res) {
		if (err) throw err
		const data = res[0]
		const indicators = res[1]
		const dessin = res[2]

		const communes = d3.set(data.map(function (d) { return d.Commune_court })).values()

		data.forEach(function (d) {
			for (let key in d) 
				if (Number.isInteger(+d[key]) && d[key] !== 0) d[key] = +d[key]
		})

		maxHeight = height() / data.length

		// // INITIALIZE THE USER INTERFACE
		Menu.init(indicators)
		UI.init() 

		Mountains.init(data)
		Map.init(dessin)
		Reasoning.init()
		// Reasoning.init(data)
		// montagnes = new Mountains(data)
	})

	// SET UP THE SCROLLING
	const header = d3.select('div.sticky-content')
	const legende = d3.select('div.slide.vis')
	
	let startsticky = header.node().clientTop || header.node().offsetTop
	let endsticky = legende.node().clientTop || legende.node().offsetTop

	d3.select(window).on('resize.sticky', function () {
		startsticky = header.node().clientTop || header.node().offsetTop
		endsticky = legende.node().clientTop || legende.node().offsetTop
	})

	d3.select(window).on('scroll', function () {
		// console.log(window.pageYOffset, endsticky - header.node().clientHeight)
		// console.log(window.pageYOffset > endsticky + height() - header.node().clientHeight)
		if (window.pageYOffset > startsticky && window.pageYOffset <= endsticky - header.node().clientHeight) {
			header.classed('stuck', false)
				.classed('stick', true)
			header.select('div.logo-separator').classed('hide', false)
		}
		else if (window.pageYOffset > endsticky - header.node().clientHeight) {
			// console.log('here')
			header.classed('stick', false)
				.classed('stuck', true)
			header.select('div.logo-separator').classed('hide', true)
		}
		else {
			header.classed('stick stuck', false)
			header.select('div.logo-separator').classed('hide', false)
		}
	})

	// if (detectVersion() === 'Firefox 52') {
	if (!areClipPathShapesSupported()) {
		const svg = d3.select('body').addElems('svg', 'img-pattern')
			.attrs({ 'width': 0, 'height': 0 })
		const defs = svg.addElems('defs')
		const gradient = defs.addElems('linearGradient', 'main-gradient')
			.attrs({ 'id': 'svg-gradient',
					 'x1': '0%',
					 'y1': '0%',
					 'x2': '0%',
					 'y2': '100%',
					 'spreadMethod': 'pad' })
		gradient.addElems('stop', 'gradient-stop', [{ offset: '0%', color: 'rgba(203,171,84,1)', opacity: .5 }, { offset: '100%', color: 'rgba(10,0,41,1)', opacity: .75 }])
			.attrs({ 'offset': function (d) { return d.offset },
					 'stop-color': function (d) { return d.color },
					 'stop-opacity': function (d) { return d.opacity } })

		const inverted_gradient = defs.addElems('linearGradient', 'inverted-gradient')
			.attrs({ 'id': 'svg-inverted-gradient',
					 'x1': '0%',
					 'y1': '0%',
					 'x2': '0%',
					 'y2': '100%',
					 'spreadMethod': 'pad' })
		inverted_gradient.addElems('stop', 'gradient-stop', [{ offset: '0%', color: 'rgba(235,233,233,1)', opacity: 1 }, { offset: '100%', color: 'rgba(10,0,41,1)', opacity: .75 }])
			.attrs({ 'offset': function (d) { return d.offset },
					 'stop-color': function (d) { return d.color },
					 'stop-opacity': function (d) { return d.opacity } })

		const logo_gradient = defs.addElems('linearGradient', 'logo-gradient')
			.attrs({ 'id': 'svg-logo-gradient',
					 'x1': '0%',
					 'y1': '0%',
					 'x2': '0%',
					 'y2': '100%',
					 'spreadMethod': 'pad' })
		logo_gradient.addElems('stop', 'gradient-stop', [{ offset: '0%', color: 'rgba(10,2,3,0)', opacity: 1 }, { offset: '100%', color: 'rgba(10,0,41,1)', opacity: 1 }])
			.attrs({ 'offset': function (d) { return d.offset },
					 'stop-color': function (d) { return d.color },
					 'stop-opacity': function (d) { return d.opacity } })

		const pattern = defs.addElems('pattern', 'main-pattern')
			.attrs({ 'id': 'bg-img',
					 'patternUnits': 'objectBoundingBox',
					 'width': 1,
					 'height': 1 })
		pattern.addElems('image')
			.attrs({ 'xlink:href': './imgs/texture-v04-c.png',
					 'x': 0,
					 'y': 0,
					 'width': Math.round(1361 / 3),
					 'height': Math.round(743 / 3) })
		pattern.addElems('rect', 'texture-gradient')
			.attrs({ 'width': 125,
					 'height': 125,
					 'x': 0,
					 'y': 0,
					 'fill': 'url(#svg-gradient)' })

		const logo_pattern = defs.addElems('pattern', 'logo-pattern')
			.attrs({ 'id': 'logo-bg-img',
					 // 'patternUnits': 'userSpaceOnUse',
					 // 'width': Math.round(1361 / 3),
					 // 'height': Math.round(743 / 3) })
					 'patternUnits': 'objectBoundingBox',
					 'width': 1,
					 'height': 1 })
		logo_pattern.addElems('image')
			.attrs({ 'xlink:href': './imgs/texture-v04-c.png',
					 'x': -Math.round(1361 / 3) * .53,
					 'y': 0,
					 'width': Math.round(1361 / 3),
					 'height': Math.round(743 / 3) })
		logo_pattern.addElems('rect', 'texture-gradient')
			.attrs({ 'width': 100,
					 'height': 100,
					 'x': 0,
					 'y': 0,
					 'fill': 'url(#svg-logo-gradient)' })

		d3.selectAll('.sommet--logo.logo-sommet-1, .sommet--logo.logo-sommet-2, .sommet--logo.logo-sommet-3')
			.classed('transparent', true)
		.addElems('svg')
			.attrs({ 'width': '100%', 
					 'height': '100%',
					 'viewBox': '0 0 100 100',
					 'preserveAspectRatio': 'none' })
		.addElems('polygon')
			.attrs({ 'points': '0,100 50,0 100,100',
					 'fill': 'url(#logo-bg-img)' })

		d3.select('.sommet--legende.discrete')
			.classed('transparent', true)
		.addElems('svg')
			.attrs({ 'width': '100%', 
					 'height': '100%',
					 'viewBox': '0 0 100 100',
					 'preserveAspectRatio': 'none' })
		.addElems('polygon')
			.attrs({ 'points': '0,100 50,0 100,100',
					 'fill': 'url(#svg-inverted-gradient)' })

		d3.select('.sommet--legende.series')
			.classed('transparent', true)
		.addElems('svg', 'shape')
			.attrs({ 'width': '100%', 
					 'height': '100%',
					 'viewBox': '0 0 100 100',
					 'preserveAspectRatio': 'none' })
		.addElems('polygon')
			.attrs({ 'points': '0,100 25,12.5 75,0 100,100',
					 'fill': 'url(#svg-inverted-gradient)' })

		d3.select('.sommet--legende.ordinal')
			.classed('transparent', true)
		.addElems('svg', 'shape')
			.attrs({ 'width': '100%', 
					 'height': '100%',
					 'viewBox': '0 0 100 100',
					 'preserveAspectRatio': 'none' })
		.addElems('polygon')
			.attrs({ 'points': '0,100 39.7577,0 69.2732,74.2383 79.5155,48.4766 100,100',
					 'fill': 'url(#svg-inverted-gradient)' })

		d3.select('.sommet--legende.addition')
			.classed('transparent', true)
		.addElems('svg')
			.attrs({ 'width': '100%', 
					 'height': '100%',
					 'viewBox': '0 0 100 100',
					 'preserveAspectRatio': 'none' })
		.addElems('polygon')
			.attrs({ 'points': '0,100 50,0 100,100',
					 'fill': 'url(#svg-inverted-gradient)' })

		d3.select('.sommet--legende.division')
			.classed('transparent', true)
		.addElems('svg')
			.attrs({ 'width': '100%', 
					 'height': '100%',
					 'viewBox': '0 0 100 100',
					 'preserveAspectRatio': 'none' })
		.addElems('polygon')
			.attrs({ 'points': '0,100 50,50 100,100',
					 'fill': 'url(#svg-inverted-gradient)' })
	}

</script>

</body>

</html>